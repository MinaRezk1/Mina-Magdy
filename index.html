<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام الحضور والغياب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Cairo', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #1e1b4b; /* indigo-950 */
        background-image:
          radial-gradient(circle at 1px 1px, rgba(255,255,255,0.04) 1px, transparent 0);
        background-size: 25px 25px;
      }
      .animate-fade-in-out {
        animation: fadeInOut 3s ease-in-out;
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(10px); }
      }
       /* Hide spin buttons on number inputs */
      input[type='number']::-webkit-inner-spin-button,
      input[type='number']::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type='number'] {
        -moz-appearance: textfield;
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

const generateId = () => `_${Math.random().toString(36).substring(2, 11)}`;

// --- Icons ---
const BarcodeIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"> <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /> <path strokeLinecap="round" strokeLinejoin="round" d="M3.375 5.25h17.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125H3.375c-.621 0-1.125-.504-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125z" /> </svg> );
const WhatsAppIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor"> <path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.6 15.31 3.43 16.78L2 22L7.42 20.62C8.82 21.39 10.38 21.81 12.04 21.81C17.5 21.81 21.95 17.36 21.95 11.91C21.95 6.45 17.5 2 12.04 2ZM16.63 15.26C16.42 15.73 15.32 16.3 14.96 16.36C14.61 16.41 14.06 16.41 13.66 16.2C13.26 16 12.38 15.69 11.33 14.73C9.98 13.48 9.25 12.08 9.06 11.66C8.88 11.24 9.06 11.03 9.22 10.86C9.36 10.71 9.53 10.5 9.71 10.29C9.88 10.08 9.94 9.92 10.05 9.71C10.16 9.5 10.1 9.32 10.03 9.17C9.95 9.03 9.4 7.82 9.17 7.28C8.95 6.74 8.72 6.83 8.56 6.83C8.4 6.83 8.21 6.83 8.03 6.83C7.85 6.83 7.56 6.9 7.33 7.17C7.11 7.45 6.54 7.98 6.54 9.17C6.54 10.36 7.36 11.49 7.49 11.66C7.61 11.83 9.17 14.34 11.63 15.4C12.26 15.68 12.75 15.82 13.13 15.93C13.69 16.08 14.24 16.03 14.63 15.92C15.08 15.8 16.03 15.24 16.24 14.77C16.45 14.3 16.45 13.91 16.37 13.79C16.3 13.68 16.15 13.62 15.94 13.51C15.73 13.4 14.96 13.01 14.74 12.92C14.53 12.83 14.38 12.77 14.23 13.01C14.09 13.25 13.73 13.72 13.6 13.86C13.48 14 13.35 14.03 13.14 13.92C12.93 13.81 12.1 13.54 11.1 12.64C10.3 11.9 9.76 11.01 9.61 10.73C9.46 10.45 9.58 10.32 9.7 10.2C9.81 10.09 9.95 9.94 10.09 9.79C10.22 9.66 10.27 9.55 10.35 9.4C10.43 9.25 10.38 9.12 10.32 9C10.27 8.88 10.16 8.62 10.1 8.5C10.03 8.38 9.97 8.28 10.03 8.17C10.1 8.05 10.16 8.03 10.24 8.03C10.33 8.03 10.42 8.03 10.49 8.04C10.57 8.04 10.63 8.04 10.73 8.25C10.82 8.46 11.23 9.32 11.23 9.32C11.23 9.32 11.29 9.42 11.4 9.42C11.52 9.42 11.61 9.37 11.71 9.26C11.8 9.16 12.21 8.7 12.35 8.52C12.48 8.34 12.59 8.33 12.7 8.41C12.81 8.49 13.29 8.73 13.49 8.84C13.68 8.95 13.81 9.01 13.88 9.11C13.94 9.2 13.94 9.45 13.88 9.6C13.81 9.74 13.73 9.85 13.65 9.94C13.58 10.04 13.48 10.15 13.4 10.24C13.32 10.33 13.21 10.46 13.31 10.64C13.41 10.82 13.81 11.26 13.81 11.26C13.81 11.26 14.21 11.71 14.35 11.83C14.49 11.95 14.54 12.03 14.6 12.08C14.65 12.13 14.73 12.23 14.8 12.2C14.88 12.18 15.31 11.93 15.48 11.82C15.65 11.71 15.82 11.7 15.97 11.8C16.12 11.91 16.37 12.35 16.45 12.57C16.52 12.8 16.6 13.01 16.63 13.1C16.63 13.1 16.63 15.26 16.63 15.26Z" /> </svg> );
const CameraIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}> <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /> <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /> </svg> );
const UserPlusIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}> <path strokeLinecap="round" strokeLinejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /> </svg> );
const XIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}> <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg> );
const ChevronDownIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> );
const LoginIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"> <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /> </svg> );
const LogoutIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"> <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /> </svg> );
const PencilIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"> <path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /> </svg> );
const CheckIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"> <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /> </svg> );
const TrashIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"> <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /> </svg> );
const UserGroupIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962c.57-1.023-.095-2.21-1.04-2.962M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7C14.453 4.546 13.232 4.5 12 4.5c-1.232 0-2.453.046-3.662.138a4.006 4.006 0 00-3.7 3.7C4.546 9.547 4.5 10.768 4.5 12c0 1.232.046 2.453.138 3.662a4.006 4.006 0 003.7 3.7c1.209.092 2.43.138 3.662.138 1.232 0 2.453-.046 3.662-.138a4.006 4.006 0 003.7-3.7c.092-1.209.138-2.43.138-3.662z" /> <path strokeLinecap="round" strokeLinejoin="round" d="M12 12a3 3 0 100-6 3 3 0 000 6z" /> </svg> );
const TrophyIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 1011.316-8.8-5.25 5.25 0 00-1.866-2.433A5.25 5.25 0 0013.5 6H12m2.672.034a5.25 5.25 0 013.586 2.433 9.75 9.75 0 01-11.316 8.8" /> <path strokeLinecap="round" strokeLinejoin="round" d="M12 12.75h.008v.008H12v-.008z" /> </svg> );
const CrownIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor"> <path d="M19.467 11.233L16.03 3.39a1.5 1.5 0 00-2.733 0L9.86 11.233 4.133 8.44a1.5 1.5 0 00-1.933 2.11l4.267 9.387a1.5 1.5 0 001.3.96h8.466a1.5 1.5 0 001.3-.96l4.267-9.387a1.5 1.5 0 00-1.933-2.11L19.467 11.233z" /> </svg> );
const KeyIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" /> </svg> );
const ShieldCheckIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /> </svg> );


// --- Components ---
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"
      onClick={onClose}
    >
      <div 
        className="bg-indigo-950 rounded-2xl shadow-xl w-full max-w-md mx-auto text-white border border-indigo-800 transform transition-all"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex justify-between items-center p-4 border-b border-indigo-800">
          <h2 className="text-xl font-bold text-amber-400">{title}</h2>
          <button 
            onClick={onClose} 
            className="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-indigo-700"
          >
            <XIcon className="w-6 h-6" />
          </button>
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};

const QRScanner = ({ onScanSuccess, onScanFailure }) => {
    const scannerRef = useRef(null);
    const isMountedRef = useRef(true);
    const [error, setError] = useState(null);
    const [permissionStatus, setPermissionStatus] = useState('loading'); // loading, granted, prompt, denied
    const [isTrying, setIsTrying] = useState(false);

    const startScanner = useCallback(async () => {
        if (!isMountedRef.current) return;
        setIsTrying(true);
        setError(null);

        if (typeof Html5Qrcode === 'undefined') {
            if (isMountedRef.current) {
                setError("مكتبة مسح الكود غير متاحة. الرجاء إعادة تحميل الصفحة.");
                if (onScanFailure) onScanFailure(new Error("مكتبة مسح الكود غير متاحة."));
                setIsTrying(false);
            }
            return;
        }
        
        let html5QrCode = scannerRef.current;
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("qr-reader");
            scannerRef.current = html5QrCode;
        }

        if (html5QrCode.isScanning) {
            try { await html5QrCode.stop(); } catch(e) { console.warn("Scanner was already scanning, failed to stop before restart:", e); }
        }

        try {
            const status = await navigator.permissions.query({ name: 'camera' });
            if (!isMountedRef.current) return;
            setPermissionStatus(status.state);
            status.onchange = () => {
                if (isMountedRef.current) {
                    setPermissionStatus(status.state);
                    if (status.state === 'denied' && scannerRef.current && scannerRef.current.isScanning) {
                        scannerRef.current.stop().catch(() => {});
                    }
                }
            };

            if (status.state === 'denied') {
                if(isMountedRef.current) {
                    setError("تم رفض الوصول إلى الكاميرا. الرجاء تمكينها من إعدادات المتصفح الخاص بك.");
                    if (onScanFailure) onScanFailure(new Error("Permission denied"));
                    setIsTrying(false);
                }
                return;
            }
        } catch (err) {
            if(isMountedRef.current) setPermissionStatus('prompt');
            console.warn("Permissions API not supported, proceeding with camera request.", err);
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        let cameraStarted = false;
        let lastError = null;

        try {
            await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, () => {});
            cameraStarted = true;
        } catch (facingModeError) {
            lastError = facingModeError;
            if (html5QrCode.isScanning) {
                try { await html5QrCode.stop(); } catch(e){ console.error("Failed to stop after facingMode error", e); }
            }
        }

        if (!cameraStarted && isMountedRef.current) {
            try {
                const cameras = await Html5Qrcode.getCameras();
                if (isMountedRef.current && cameras && cameras.length > 0) {
                    const uniqueCameras = Array.from(new Map(cameras.map(item => [item.id, item])).values());
                    const prioritizedCameras = [
                        ...uniqueCameras.filter(c => c.label.toLowerCase().includes('back') || c.label.toLowerCase().includes('خلفية')),
                        ...uniqueCameras.filter(c => !c.label.toLowerCase().includes('back') && !c.label.toLowerCase().includes('خلفية'))
                    ];
                    
                    for (const camera of prioritizedCameras) {
                        if (!isMountedRef.current) break;
                        try {
                            if (html5QrCode.isScanning) await html5QrCode.stop();
                            await html5QrCode.start(camera.id, config, onScanSuccess, () => {});
                            cameraStarted = true;
                            break;
                        } catch (startError) {
                            lastError = startError;
                        }
                    }
                }
            } catch (enumerationError) {
                lastError = enumerationError;
            }
        }

        if (isMountedRef.current) {
            if (cameraStarted) {
                 setError(null);
            } else {
                const err = lastError || new Error("فشل تشغيل أي كاميرا متاحة.");
                let userMessage = "فشل تشغيل الكاميرا. تأكد من منح الأذونات وأن الكاميرا ليست قيد الاستخدام من قبل تطبيق آخر.";
                
                if (err.name === "NotAllowedError") {
                    userMessage = "تم رفض إذن الوصول إلى الكاميرا. الرجاء السماح بالوصول في إعدادات المتصفح.";
                } else if (err.name === "NotFoundError" || (err.message && err.message.includes("Requested device not found"))) {
                    userMessage = "لم يتم العثور على كاميرا متوافقة على هذا الجهاز.";
                } else if (err.name === "NotReadableError" || (err.message && err.message.includes("Could not start video source"))) {
                    userMessage = "لا يمكن الوصول إلى الكاميرا. قد تكون قيد الاستخدام من قبل تطبيق آخر. جرب إغلاق أي تطبيقات أخرى تستخدم الكاميرا (مثل Zoom أو كاميرا النظام) وأعد تحميل الصفحة.";
                } else if (err.message) {
                   const isInternalError = err.message.includes("html5-qrcode-cli") || err.message.includes("QR code parse error");
                   if (!isInternalError) {
                       userMessage = err.message;
                   }
                }
                
                setError(userMessage);
                if (onScanFailure) onScanFailure(err);
            }
            setIsTrying(false);
        }
    }, [onScanSuccess, onScanFailure]);

    useEffect(() => {
        isMountedRef.current = true;
        
        const checkLibraryAndStart = () => {
            if (typeof Html5Qrcode !== 'undefined') {
                startScanner();
            } else {
                setTimeout(checkLibraryAndStart, 100);
            }
        };

        checkLibraryAndStart();

        return () => {
            isMountedRef.current = false;
            if (scannerRef.current && scannerRef.current.isScanning) {
                scannerRef.current.stop().catch(err => {
                    console.warn("Failed to stop scanner on unmount:", err);
                });
            }
        };
    }, [startScanner]);
    
    let content;
    if (error) {
        content = (
             <div className="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950 p-4 text-center">
                <p className="text-red-400 font-semibold mb-2">{error}</p>
                {permissionStatus === 'denied' && (
                    <p className="text-indigo-300 text-sm mt-2">
                        قد تحتاج إلى الذهاب إلى إعدادات الموقع لهذا الموقع (عادة عن طريق النقر على أيقونة القفل في شريط العنوان) وإعادة تمكين إذن الكاميرا.
                    </p>
                )}
                <button
                    onClick={startScanner}
                    disabled={isTrying}
                    className="mt-4 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition-colors disabled:bg-amber-500/50 disabled:cursor-wait"
                >
                    {isTrying ? 'جاري المحاولة...' : 'إعادة المحاولة'}
                </button>
            </div>
        );
    } else if (isTrying || permissionStatus === 'loading' || permissionStatus === 'prompt') {
         content = (
             <div className="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950 p-4 text-center">
                <p className="text-amber-400 font-semibold animate-pulse">
                    {isTrying ? 'جاري تشغيل الكاميرا...' : 'جاري طلب إذن الوصول...'}
                </p>
                {permissionStatus === 'prompt' && <p className="text-indigo-300 text-sm mt-2">
                    الرجاء السماح بالوصول في النافذة المنبثقة التي تظهر في متصفحك.
                </p>}
            </div>
        );
    }

    return (
        <div className="w-full relative aspect-square bg-indigo-950/50 rounded-lg overflow-hidden flex items-center justify-center border-4 border-indigo-800">
            <div id="qr-reader" className="w-full h-full"></div>
            {content}
        </div>
    );
};


const BarcodeDisplay = ({ studentId }) => {
    const barcodeRef = useRef(null);

    useEffect(() => {
        if (barcodeRef.current && studentId && typeof JsBarcode !== 'undefined') {
            try {
                JsBarcode(barcodeRef.current, studentId, {
                    format: "CODE128",
                    displayValue: false,
                    lineColor: "#ffffff",
                    background: "transparent",
                    margin: 10,
                    width: 2.5,
                    height: 100,
                });
            } catch (e) {
                console.error("JsBarcode error:", e);
            }
        }
    }, [studentId]);

    return (
        <div className="flex justify-center items-center p-4 bg-indigo-900 rounded-lg">
            <svg ref={barcodeRef}></svg>
        </div>
    );
};

const PointActions = ({ student, addPoints, onActionAfterAdd, fromScan = false }) => {
    const [participationPoints, setParticipationPoints] = useState('1');
    const [participationDescription, setParticipationDescription] = useState('');

    const rules = useMemo(() => {
        if (!student) return {};

        const history = student.attendanceHistory || [];
        const todayStr = new Date().toLocaleDateString('en-CA');
        const currentMonthStr = todayStr.substring(0, 7);
        
        const hasReceivedPointsToday = (type) => history.some(h => h.date === todayStr && h.type === type);
        const hasReceivedAttendanceToday = hasReceivedPointsToday('early') || hasReceivedPointsToday('late');
        const hasReceivedGamesStationToday = hasReceivedPointsToday('gamesStation');
        const hasReceivedMassThisMonth = history.some(h =>
            h.date.startsWith(currentMonthStr) && h.type === 'monthlyMass'
        );
        
        const confessionHistory = history.filter(h => h.type === 'confession').sort((a, b) => new Date(b.date) - new Date(a.date));
        const lastConfessionDate = confessionHistory.length > 0 ? new Date(confessionHistory[0].date) : null;
        let canAddConfession = true;
        if (lastConfessionDate) {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            if (lastConfessionDate > thirtyDaysAgo) {
                canAddConfession = false;
            }
        }

        return {
            canAddMass: !hasReceivedMassThisMonth,
            canAddEarly: !hasReceivedAttendanceToday,
            canAddLate: !hasReceivedAttendanceToday,
            canAddConfession: canAddConfession,
            canAddGamesStation: !hasReceivedGamesStationToday,
            canAddParticipation: true,
        };
    }, [student]);

    const handleAddPoints = (type, points, description = null) => {
        addPoints(student.id, type, points, fromScan, description);
        if (onActionAfterAdd) {
            onActionAfterAdd();
        }
    };
    
    if (!student) return null;

    return (
        <div className="space-y-3">
            <button
                onClick={() => handleAddPoints('monthlyMass', 25)}
                disabled={!rules.canAddMass}
                className="w-full p-3 text-white font-bold rounded-lg transition-colors bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
            >
                قداس شهري (+25 نقطة)
            </button>
            <button
                onClick={() => handleAddPoints('early', 10)}
                disabled={!rules.canAddEarly}
                className="w-full p-3 text-white font-bold rounded-lg transition-colors bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
            >
                حضور مبكر (+10 نقاط)
            </button>
            <button
                onClick={() => handleAddPoints('late', 5)}
                disabled={!rules.canAddLate}
                className="w-full p-3 text-white font-bold rounded-lg transition-colors bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
            >
                حضور متأخر (+5 نقاط)
            </button>
             <button
                onClick={() => handleAddPoints('confession', 15)}
                disabled={!rules.canAddConfession}
                className="w-full p-3 text-white font-bold rounded-lg transition-colors bg-rose-600 hover:bg-rose-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
            >
                اعتراف (+15 نقطة)
            </button>

            <div className="!mt-4 pt-3 border-t border-indigo-800">
                <label className="text-sm font-medium text-indigo-300 mb-2 block">نقاط Games Station:</label>
                <div className="grid grid-cols-3 gap-2">
                    <button
                        onClick={() => handleAddPoints('gamesStation', 15)}
                        disabled={!rules.canAddGamesStation}
                        className="w-full p-2 text-white text-sm font-bold rounded-lg transition-colors bg-amber-600 hover:bg-amber-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    >
                        الأول (+15)
                    </button>
                    <button
                        onClick={() => handleAddPoints('gamesStation', 10)}
                        disabled={!rules.canAddGamesStation}
                        className="w-full p-2 text-white text-sm font-bold rounded-lg transition-colors bg-slate-500 hover:bg-slate-600 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    >
                        الثاني (+10)
                    </button>
                    <button
                        onClick={() => handleAddPoints('gamesStation', 5)}
                        disabled={!rules.canAddGamesStation}
                        className="w-full p-2 text-white text-sm font-bold rounded-lg transition-colors bg-orange-700 hover:bg-orange-800 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    >
                        الثالث (+5)
                    </button>
                </div>
            </div>
            
            <div className="!mt-4 pt-3 border-t border-indigo-800 space-y-3">
                 <label className="text-sm font-medium text-indigo-300 mb-1 block">نقاط المشاركة:</label>
                 <div className="flex items-center gap-2">
                    <input
                        type="number"
                        id={`participation-points-${student.id}`}
                        min="-10"
                        max="50"
                        value={participationPoints}
                        onChange={(e) => {
                            const value = e.target.value;
                            if (/^-?[0-9]*$/.test(value)) {
                                const num = parseInt(value, 10);
                                if ((!isNaN(num) && num >= -10 && num <= 50) || value === '' || value === '-') {
                                    setParticipationPoints(value);
                                } else if (value.length > 0) { // handle case where user pastes a value > 50 or < -10
                                    const clamped = Math.max(-10, Math.min(50, num));
                                    setParticipationPoints(String(clamped));
                                }
                            }
                        }}
                        onBlur={() => {
                            const num = parseInt(participationPoints, 10);
                            if (isNaN(num) || participationPoints === '' || participationPoints === '-') {
                                setParticipationPoints('1');
                            } else {
                                const clamped = Math.max(-10, Math.min(50, num));
                                setParticipationPoints(String(clamped));
                            }
                        }}
                        className="w-24 rounded-md border-indigo-700 bg-indigo-800 text-white text-center focus:border-amber-500 focus:ring-amber-500"
                        disabled={!rules.canAddParticipation}
                    />
                    <button
                        onClick={() => {
                            const points = parseInt(participationPoints, 10);
                            if (!isNaN(points)) {
                                handleAddPoints('participation', points, participationDescription);
                                setParticipationDescription('');
                                setParticipationPoints('1');
                            }
                        }}
                        disabled={!rules.canAddParticipation || isNaN(parseInt(participationPoints, 10)) || participationPoints === '' || participationPoints === '-'}
                        className="flex-1 rounded-md bg-sky-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-700 disabled:bg-gray-600 disabled:cursor-not-allowed"
                    >
                        إضافة النقاط
                    </button>
                 </div>
                 <input
                    type="text"
                    placeholder="سبب المشاركة (اختياري)"
                    value={participationDescription}
                    onChange={(e) => setParticipationDescription(e.target.value)}
                    className="w-full rounded-md border-indigo-700 bg-indigo-800 text-white placeholder-indigo-400 focus:border-amber-500 focus:ring-amber-500 px-3 py-2 text-sm"
                    disabled={!rules.canAddParticipation}
                />
            </div>
        </div>
    );
};


// --- App Component ---
const App = () => {
    const [students, setStudents] = useState([]);
    const [admins, setAdmins] = useState([]);
    
    const [newStudentName, setNewStudentName] = useState('');
    const [newStudentPhone, setNewStudentPhone] = useState('');
    const [isScannerOpen, setScannerOpen] = useState(false);
    const [scannedStudent, setScannedStudent] = useState(null);
    const [expandedStudentId, setExpandedStudentId] = useState(null);
    const [visibleHistoryStudentId, setVisibleHistoryStudentId] = useState(null);
    const [studentForAttendance, setStudentForAttendance] = useState(null);
    const [studentForBarcode, setStudentForBarcode] = useState(null);
    const [toastMessage, setToastMessage] = useState(null);
    
    const [loggedInAdmin, setLoggedInAdmin] = useState(null);
    const [isAuthModalOpen, setAuthModalOpen] = useState(false);
    const [selectedAdmin, setSelectedAdmin] = useState(null);
    const [pinInput, setPinInput] = useState('');
    const [authError, setAuthError] = useState('');

    const [editingStudent, setEditingStudent] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [activeView, setActiveView] = useState('students'); // 'students' or 'leaderboard'
    const [studentToDelete, setStudentToDelete] = useState(null);
    const [pointToDelete, setPointToDelete] = useState(null);
    
    // Super admin state & modals
    const [isAddStudentModalOpen, setAddStudentModalOpen] = useState(false);
    const [isAdminManagementModalOpen, setAdminManagementModalOpen] = useState(false);
    const [newAdminName, setNewAdminName] = useState('');
    const [newAdminPin, setNewAdminPin] = useState('');
    const [editingAdminId, setEditingAdminId] = useState(null);
    const [editingAdminPinValue, setEditingAdminPinValue] = useState('');
    
    const isInitialMount = useRef(true);

    // Initialize Students Data
    useEffect(() => {
        const initializeData = () => {
            const initialStudentsData = [
                { name: 'ابانوب ايليا ملك', phone: '01204436684' }, { name: 'ابانوب داود بخيت', phone: '01223229138' }, { name: 'ابانوب هاني', phone: '' }, { name: 'ابرام داود بخيت جرجس', phone: '' }, { name: 'ابرام ياسر', phone: '' }, { name: 'استيفن متري', phone: '' }, { name: 'اندور صفوت واصف قزمان موسي', phone: '01220959535' }, { name: 'انطونيوس سامح', phone: '' }, { name: 'انطونيوس سمير عزيز', phone: '01223746319' }, { name: 'أنطون طارق', phone: '01279826512' }, { name: 'بافلى جورج', phone: '01210974334' }, { name: 'بافلي اسامة جرجس', phone: '' }, { name: 'بافلي رافت ميخائيل غبريال', phone: '' }, { name: 'بافلي سمير', phone: '' }, { name: 'بولا مجدي', phone: '' }, { name: 'بولا ميلاد عوض اللة', phone: '01223064403' }, { name: 'بولا ياسر ابراهيم', phone: '' }, { name: 'بيشوي عماد ارمانيوس', phone: '' }, { name: 'بيشوي فرج الله عياد', phone: '' }, { name: 'بيير عماد', phone: '' }, { name: 'توماس اشرف', phone: '01224397257' }, { name: 'تونى سعيد جابر', phone: '01222833460' }, { name: 'توني ريمون', phone: '' }, { name: 'جرجس صابر', phone: '' }, { name: 'جرجس نبيل', phone: '' }, { name: 'جورج شريف', phone: '' }, { name: 'جورج وجيه', phone: '' }, { name: 'جوسيان جرجس', phone: '' }, { name: 'جوفاني مايكل', phone: '' }, { name: 'جوناثان ممدوح لبيب', phone: '01212167401' }, { name: 'حوفاني هاني', phone: '' }, { name: 'دانيال يوسف', phone: '01275079109' }, { name: 'دانيال يوسف', phone: '' }, { name: 'ديفيد سامح', phone: '' }, { name: 'ديفيد هاني', phone: '' }, { name: 'روماني سمير', phone: '' }, { name: 'سامي وحيد منير', phone: '' }, { name: 'سبستيان ممدوح فتحي عزمي', phone: '01206193106' }, { name: 'صموئيل ميخائيل نظير', phone: '' }, { name: 'فادي إيهاب', phone: '' }, { name: 'فادي رامزي وليم', phone: '' }, { name: 'فادي رامي صبري', phone: '' }, { name: 'فادي وليد عبد الحكيم', phone: '' }, { name: 'فيلوباتير امجد', phone: '' }, { name: 'فيلوباتير خلف منقريوس', phone: '01221743554' }, { name: 'فيلوباتير رامي مجدي مينا', phone: '' }, { name: 'فيلوباتير عادل', phone: '' }, { name: 'قيلوباتير ماهر', phone: '' }, { name: 'كيرلس اسامة', phone: '' }, { name: 'كيرلس اسامة حنا', phone: '01270543922' }, { name: 'كيرلس عيسي عدلي', phone: '' }, { name: 'كيرلس فليب فوزى', phone: '01283999238' }, { name: 'كيرلس ماجد', phone: '' }, { name: 'كيرلس ميلاد يوسف فهيم', phone: '01288745291' }, { name: 'كيرلس نادى', phone: '01276314822' }, { name: 'كيرلس وجدي', phone: '' }, { name: 'مارك أيهاب صلاح', phone: '' }, { name: 'مارك ريتشارد انطون', phone: '' }, { name: 'مارك هانى', phone: '' }, { name: 'مارك هاني نبيل', phone: '' }, { name: 'ماركو عاطف', phone: '' }, { name: 'ماريو ممدوح', phone: '' }, { name: 'ماريو وائل', phone: '' }, { name: 'مرقص معوض مرقص', phone: '' }, { name: 'مكاريوس عاطف', phone: '' }, { name: 'موسي ماهر موسي', phone: '' }, { name: 'مينا ايهاب عطالله عطيه', phone: '' }, { name: 'مينا جرجس حليم', phone: '' }, { name: 'مينا ريمون سمير', phone: '' }, { name: 'مينا مايكل مجدي', phone: '' }, { name: 'مينا ميلاد', phone: '' }, { name: 'مينا هاني بخيت', phone: '' }, { name: 'نوفير باسيلي', phone: '' }, { name: 'نوفير جورج طانيوس داود', phone: '' }, { name: 'نوفير ماجد', phone: '' }, { name: 'نوفير مايكل', phone: '' }, { name: 'نوفير هاني', phone: '' }, { name: 'يوسف جورج', phone: '' }, { name: 'يوسف عادل عريان', phone: '' }, { name: 'يوسف مصباح وليم حنا حبيش', phone: '' }, { name: 'يوسف نحميا جرجس', phone: '' }
            ];
            const newStudents = initialStudentsData.map(s => ({
                ...s,
                id: generateId(),
                points: 0,
                lastAttended: null,
                attendanceHistory: [],
            }));
            setStudents(newStudents);
            try {
                localStorage.setItem('church_attendance_students_v5', JSON.stringify(newStudents));
            } catch (saveError) {
                console.error("Failed to save initial students to localStorage", saveError);
            }
        };

        try {
            const storedStudents = localStorage.getItem('church_attendance_students_v5');
            if (storedStudents !== null) { // Check for null to allow empty array '[]' as valid state
                const parsedStudents = JSON.parse(storedStudents);
                 if (Array.isArray(parsedStudents)) {
                    const migratedStudents = parsedStudents.map(student => ({
                        ...student,
                        attendanceHistory: (student.attendanceHistory || []).map(record => ({
                            ...record,
                            id: record.id || `rec_${Math.random().toString(36).substring(2, 9)}`
                        }))
                    }));
                    setStudents(migratedStudents);
                 } else {
                    initializeData();
                 }
            } else {
                initializeData();
            }
        } catch (error) {
            console.error("Failed to load or parse students from localStorage, re-initializing.", error);
            initializeData();
        }
    }, []);

    // Initialize Admins Data
    useEffect(() => {
        try {
            const storedAdmins = localStorage.getItem('church_attendance_admins_v5');
            if (storedAdmins) {
                setAdmins(JSON.parse(storedAdmins));
            } else {
                const initialAdmins = [
                    { id: 'admin_mina_rizk', name: 'مينا رزق', pin: '1218' },
                    { id: 'admin_shady_sameh', name: 'شادي سامح', pin: '2846' },
                    { id: 'admin_mina_moawad', name: 'مينا معوض', pin: '7520' },
                    { id: 'admin_kirollos_raafat', name: 'كيرلس رأفت', pin: '7117' },
                    { id: 'admin_nagy_wiliam', name: 'ناجي وليم', pin: '2846' }
                ].map(admin => ({
                    ...admin,
                    isLocked: false,
                    failedAttempts: 0,
                    isSuperAdmin: admin.id === 'admin_mina_rizk',
                }));
                setAdmins(initialAdmins);
            }
        } catch (error) {
            console.error("Failed to load admins from localStorage", error);
            // Fallback to default if parsing fails
            const initialAdmins = [
                { id: 'admin_mina_rizk', name: 'مينا رزق', pin: '1218' },
                { id: 'admin_shady_sameh', name: 'شادي سامح', pin: '2846' },
                { id: 'admin_mina_moawad', name: 'مينا معوض', pin: '7520' },
                { id: 'admin_kirollos_raafat', name: 'كيرلس رأفت', pin: '7117' },
                { id: 'admin_nagy_wiliam', name: 'ناجي وليم', pin: '2846' }
            ].map(admin => ({
                ...admin,
                isLocked: false,
                failedAttempts: 0,
                isSuperAdmin: admin.id === 'admin_mina_rizk',
            }));
            setAdmins(initialAdmins);
        }
    }, []);


    // Persist Students to localStorage
    useEffect(() => {
        if (isInitialMount.current) {
            isInitialMount.current = false;
            return;
        }
        try {
            localStorage.setItem('church_attendance_students_v5', JSON.stringify(students));
        } catch (error) {
            console.error("Failed to save students to localStorage", error);
        }
    }, [students]);

    // Persist Admins to localStorage
    useEffect(() => {
        if (admins.length > 0) {
            try {
                localStorage.setItem('church_attendance_admins_v5', JSON.stringify(admins));
            } catch (error) {
                console.error("Failed to save admins to localStorage", error);
            }
        }
    }, [admins]);

    const showToast = useCallback((message) => {
        setToastMessage(message);
        setTimeout(() => setToastMessage(null), 3000);
    }, []);

    const addStudent = useCallback(() => {
        if (!newStudentName.trim()) {
            showToast('الرجاء إدخال اسم المخدوم');
            return;
        }
        if (!newStudentPhone.trim()) {
            showToast('الرجاء إدخال رقم الموبايل');
            return;
        }
        const trimmedName = newStudentName.trim();
        const isDuplicate = students.some(s => s.name.toLowerCase() === trimmedName.toLowerCase());

        if (isDuplicate) {
            showToast(`"${trimmedName}" موجود بالفعل في القائمة`);
            return;
        }

        const newStudent = {
            id: generateId(),
            name: trimmedName,
            phone: newStudentPhone.trim(),
            points: 0,
            lastAttended: null,
            attendanceHistory: [],
        };
        const updatedStudents = [...students, newStudent].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        setStudents(updatedStudents);
        setNewStudentName('');
        setNewStudentPhone('');
        setAddStudentModalOpen(false);
        showToast(`تمت إضافة "${trimmedName}" بنجاح`);
    }, [newStudentName, newStudentPhone, students, showToast]);
    
    const addPoints = useCallback((studentId, type, points, fromScan = false, description = null) => {
        if (!loggedInAdmin) {
            showToast('يجب تسجيل الدخول أولاً لإضافة نقاط.');
            return;
        }
        const today = new Date().toLocaleDateString('en-CA');
        
        setStudents(prevStudents => {
            const studentIndex = prevStudents.findIndex(s => s.id === studentId);
            if (studentIndex === -1) return prevStudents;

            const student = { ...prevStudents[studentIndex] };
            student.attendanceHistory = student.attendanceHistory || [];

            const typeNameMap = {
                early: 'حضور مبكر',
                late: 'حضور متأخر',
                participation: 'مشاركة',
                monthlyMass: 'قداس شهري',
                confession: 'اعتراف',
                gamesStation: 'Games Station'
            };

            const newRecord = {
                id: generateId(),
                date: today,
                points: points,
                type: type,
                typeName: typeNameMap[type] || 'نشاط',
                description: description && description.trim() ? description.trim() : null,
                recordedBy: loggedInAdmin.name,
            };

            student.points = (student.points || 0) + points;
            if (type === 'early' || type === 'late') {
                student.lastAttended = today;
            }
            student.attendanceHistory = [newRecord, ...student.attendanceHistory];

            const updatedStudents = [...prevStudents];
            updatedStudents[studentIndex] = student;
            
            const pointsString = points > 0 ? `+${points}` : points;
            showToast(`تم تسجيل ${typeNameMap[type]} لـ ${student.name} (${pointsString} نقاط)`);
            
            if (fromScan) {
                setScannedStudent(student);
            }
            
            return updatedStudents;
        });
    }, [showToast, loggedInAdmin]);


    const handleScanSuccess = useCallback((decodedText) => {
        setScannerOpen(false);
        const student = students.find(s => s.id === decodedText);
        if (student) {
            setStudentForAttendance(student);
        } else {
            showToast('لم يتم العثور على المخدوم. الكود غير صالح.');
            setScannedStudent(null);
        }
    }, [students, showToast]);
    
    const handlePinSubmit = (e) => {
        e.preventDefault();
        const adminToLogin = admins.find(a => a.id === selectedAdmin.id);
        if (!adminToLogin) {
            setAuthError('حدث خطأ غير متوقع.');
            return;
        }

        if (adminToLogin.isLocked) {
            setAuthError('تم قفل هذا الحساب. الرجاء التواصل مع مسئول النظام.');
            return;
        }

        if (pinInput === adminToLogin.pin) {
            setLoggedInAdmin(adminToLogin);
            setAuthModalOpen(false);
            showToast(`أهلاً بك, ${adminToLogin.name}`);
            
            if (adminToLogin.failedAttempts > 0) {
                setAdmins(prevAdmins => prevAdmins.map(a => 
                    a.id === adminToLogin.id ? { ...a, failedAttempts: 0 } : a
                ));
            }
        } else {
            if (adminToLogin.isSuperAdmin) {
                setAuthError('رقم سري خاطئ. حاول مرة أخرى.');
                return;
            }

            const newFailedAttempts = (adminToLogin.failedAttempts || 0) + 1;
            let isNowLocked = false;
            let errorMessage = '';

            if (newFailedAttempts >= 5) {
                isNowLocked = true;
                errorMessage = 'تم قفل الحساب بعد 5 محاولات فاشلة.';
            } else {
                errorMessage = `رقم سري خاطئ. تبقى ${5 - newFailedAttempts} محاولات.`;
            }
            
            setAuthError(errorMessage);
            setAdmins(prevAdmins => prevAdmins.map(a =>
                a.id === adminToLogin.id ? { ...a, failedAttempts: newFailedAttempts, isLocked: isNowLocked } : a
            ));
        }
    };

    
    const handleLogout = () => {
        showToast(`تم تسجيل خروج ${loggedInAdmin.name}`);
        setLoggedInAdmin(null);
    };
    
    const openAuthModal = () => {
        setSelectedAdmin(null);
        setPinInput('');
        setAuthError('');
        setAuthModalOpen(true);
    };

    const toggleStudentDetails = (studentId) => {
        setExpandedStudentId(prevId => (prevId === studentId ? null : studentId));
        setVisibleHistoryStudentId(null); // Close history when collapsing student
    };

    const toggleHistoryDetails = (studentId) => {
        setVisibleHistoryStudentId(prevId => prevId === studentId ? null : studentId);
    };


    const handleEditPhone = (student) => {
        setEditingStudent({ id: student.id, phone: student.phone || '' });
    };

    const handleSavePhone = (studentId) => {
        if (!editingStudent) return;
        setStudents(prev => prev.map(s => s.id === studentId ? { ...s, phone: editingStudent.phone } : s));
        setEditingStudent(null);
        showToast('تم تحديث رقم الموبايل بنجاح');
    };
    
    const handleCancelEdit = () => {
        setEditingStudent(null);
    };

    const handleDeleteStudent = (studentId) => {
        const student = students.find(s => s.id === studentId);
        if (student) {
            setStudentToDelete(student);
        }
    };
    
    const confirmDeleteStudent = () => {
        if (!studentToDelete) return;
        const updatedStudents = students.filter(s => s.id !== studentToDelete.id);
        setStudents(updatedStudents);
        showToast(`تم حذف ${studentToDelete.name} بنجاح.`);
        setStudentToDelete(null);
        setExpandedStudentId(null);
    };
    
    const handleDeletePointEntry = (studentId, record) => {
        setPointToDelete({ studentId, record });
    };

    const confirmDeletePointEntry = () => {
        if (!pointToDelete) return;
        const { studentId, record } = pointToDelete;

        setStudents(prevStudents => {
            return prevStudents.map(student => {
                if (student.id === studentId) {
                    const newHistory = student.attendanceHistory.filter(h => h.id !== record.id);
                    const newPoints = (student.points || 0) - record.points;
                    return { ...student, points: newPoints, attendanceHistory: newHistory };
                }
                return student;
            });
        });

        showToast(`تم حذف نقطة (${record.typeName}) بنجاح.`);
        setPointToDelete(null);
    };


    // --- Super Admin Functions ---
    const handleAddAdmin = () => {
        const name = newAdminName.trim();
        const pin = newAdminPin.trim();

        if (!name || !pin) {
            showToast("الرجاء إدخال اسم ورقم سري للخادم الجديد.");
            return;
        }
        if (!/^\d{4,}$/.test(pin)) {
            showToast("الرقم السري يجب أن يتكون من 4 أرقام على الأقل.");
            return;
        }
        if (admins.some(a => a.name.toLowerCase() === name.toLowerCase())) {
            showToast("هذا الاسم موجود بالفعل.");
            return;
        }

        const newAdmin = {
            id: `admin_${name.replace(/\s+/g, '_').toLowerCase()}_${generateId()}`,
            name: name,
            pin: pin,
            isLocked: false,
            failedAttempts: 0,
            isSuperAdmin: false
        };

        setAdmins(prev => [...prev, newAdmin]);
        setNewAdminName('');
        setNewAdminPin('');
        showToast(`تم إضافة الخادم "${name}" بنجاح.`);
    };

    const handleUnlockAdminByFailure = (adminId) => {
        setAdmins(prevAdmins => prevAdmins.map(admin => {
            if (admin.id === adminId) {
                return { ...admin, isLocked: false, failedAttempts: 0 };
            }
            return admin;
        }));
        showToast("تم فتح قفل الحساب بنجاح.");
    };

    const handleToggleAdminStatus = (adminId) => {
        setAdmins(prevAdmins => prevAdmins.map(admin => {
            if (admin.id === adminId) {
                const isCurrentlyLocked = admin.isLocked || false;
                showToast(isCurrentlyLocked ? `تم تفعيل حساب ${admin.name}` : `تم تعطيل حساب ${admin.name}`);
                return { ...admin, isLocked: !isCurrentlyLocked, failedAttempts: 0 }; // also reset attempts
            }
            return admin;
        }));
    };

    const handleStartEditPin = (admin) => {
        setEditingAdminId(admin.id);
        setEditingAdminPinValue('');
    };

    const handleSaveAdminPin = (adminId) => {
        if (!/^\d{4,}$/.test(editingAdminPinValue)) {
            showToast("الرقم السري يجب أن يتكون من 4 أرقام على الأقل.");
            return;
        }
        setAdmins(prev => prev.map(a => a.id === adminId ? { ...a, pin: editingAdminPinValue } : a));
        showToast(`تم تغيير الرقم السري بنجاح.`);
        setEditingAdminId(null);
        setEditingAdminPinValue('');
    };


    const sortedStudents = useMemo(() => {
        return [...students].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
    }, [students]);

    const filteredStudents = useMemo(() => {
        if (!searchTerm) {
            return sortedStudents;
        }
        return sortedStudents.filter(student =>
            student.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }, [sortedStudents, searchTerm]);

    const leaderboardStudents = useMemo(() => {
        return [...students]
            .sort((a, b) => (b.points || 0) - (a.points || 0));
    }, [students]);
    
    const { superAdmin, otherAdmins } = useMemo(() => {
        const superAdmin = admins.find(a => a.isSuperAdmin);
        const otherAdmins = admins.filter(a => !a.isSuperAdmin);
        return { superAdmin, otherAdmins };
    }, [admins]);

    const isAuthenticated = !!loggedInAdmin;
    
    return (
        <div className="text-slate-100 min-h-screen p-4 md:p-8">
            <div className="max-w-4xl mx-auto">
                <header className="flex justify-between items-center mb-6 pb-4 border-b border-indigo-800/50">
                    <div>
                        <h1 className="text-3xl md:text-4xl font-bold text-amber-400 tracking-wider">اجتماع الأنبا رويس - شباب ثانوي</h1>
                        <p className="text-lg text-indigo-300 mt-1">كنيسة مارمينا مدينة الأحلام</p>
                    </div>
                    {isAuthenticated ? (
                        <div className="text-left">
                            <span className="text-amber-400 font-semibold block">مرحباً, {loggedInAdmin.name}</span>
                             <button onClick={handleLogout} className="flex items-center gap-2 text-red-400 hover:text-red-300 font-bold py-1 rounded-lg transition-colors text-sm">
                                <LogoutIcon className="w-4 h-4" />
                                <span>خروج</span>
                            </button>
                        </div>
                    ) : (
                         <button onClick={openAuthModal} className="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                           <LoginIcon className="w-5 h-5" />
                           <span>دخول خدام</span>
                        </button>
                    )}
                </header>
                
                <main>
                    <div className="mb-6 bg-indigo-900/70 p-1.5 rounded-xl flex items-center gap-2 border border-indigo-800/50">
                        <button onClick={() => setActiveView('students')} className={`w-full text-center rounded-lg py-2 font-bold flex items-center justify-center gap-2 transition-colors ${activeView === 'students' ? 'bg-indigo-700 text-amber-400' : 'text-indigo-300 hover:bg-indigo-800/50'}`}>
                            <UserGroupIcon className="w-6 h-6" />
                            <span>قائمة المخدومين ({students.length})</span>
                        </button>
                         <button onClick={() => setActiveView('leaderboard')} className={`w-full text-center rounded-lg py-2 font-bold flex items-center justify-center gap-2 transition-colors ${activeView === 'leaderboard' ? 'bg-indigo-700 text-amber-400' : 'text-indigo-300 hover:bg-indigo-800/50'}`}>
                             <TrophyIcon className="w-6 h-6" />
                             <span>لوحة الصدارة</span>
                         </button>
                    </div>

                    {activeView === 'students' && (
                        <div>
                            <div className="mb-6">
                                <input
                                    type="text"
                                    placeholder="ابحث عن مخدوم..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full bg-indigo-900/70 text-white placeholder-indigo-300 border border-indigo-800/50 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-amber-500"
                                />
                            </div>

                            <div className="space-y-3">
                                {filteredStudents.map(student => (
                                    <div key={student.id} id={`student-card-${student.id}`} className="bg-indigo-900/70 rounded-xl shadow-md border border-indigo-800/50 overflow-hidden">
                                        <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-indigo-800/50 transition-colors" onClick={() => toggleStudentDetails(student.id)}>
                                            <div className='flex items-center gap-4'>
                                                <div className="text-amber-400 font-bold text-xl w-8 text-center">{student.points || 0}</div>
                                                <span className="text-lg font-semibold">{student.name}</span>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                 {student.lastAttended === new Date().toLocaleDateString('en-CA') && (
                                                    <span className="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded-full">حضر اليوم</span>
                                                )}
                                                <ChevronDownIcon className={`w-6 h-6 text-gray-400 transition-transform ${expandedStudentId === student.id ? 'rotate-180' : ''}`} />
                                            </div>
                                        </div>

                                        {expandedStudentId === student.id && (
                                            <div className="p-4 border-t border-indigo-800/50 bg-indigo-900/50">
                                                <div className="flex justify-between items-center mb-4">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-indigo-300">رقم الموبايل:</span>
                                                        {editingStudent?.id === student.id ? (
                                                            <div className='flex items-center gap-2'>
                                                                <input
                                                                     type="tel"
                                                                     value={editingStudent.phone}
                                                                     onChange={(e) => setEditingStudent({...editingStudent, phone: e.target.value})}
                                                                     className="bg-indigo-700 text-white border border-indigo-600 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-amber-500"
                                                                     autoFocus
                                                                 />
                                                                  <button onClick={() => handleSavePhone(student.id)} className="text-green-400 hover:text-green-300 p-1"><CheckIcon className="w-5 h-5"/></button>
                                                                  <button onClick={handleCancelEdit} className="text-red-400 hover:text-red-300 p-1"><XIcon className="w-5 h-5"/></button>
                                                            </div>
                                                        ) : (
                                                            <div className='flex items-center gap-2'>
                                                                 <span className="font-mono">{student.phone || 'لا يوجد'}</span>
                                                                 {isAuthenticated && (
                                                                    <button onClick={() => handleEditPhone(student)} className="text-gray-400 hover:text-white"><PencilIcon className="w-4 h-4"/></button>
                                                                 )}
                                                            </div>
                                                        )}
                                                    </div>

                                                    <div className='flex items-center gap-4'>
                                                        {isAuthenticated && (
                                                            <button 
                                                                onClick={() => setStudentForBarcode(student)}
                                                                className="text-sky-400 hover:text-sky-300 transition-colors"
                                                                aria-label="عرض الباركود"
                                                            >
                                                                <BarcodeIcon className="w-6 h-6" />
                                                            </button>
                                                        )}
                                                        {student.phone && (
                                                            <a href={`https://wa.me/2${student.phone}`} target="_blank" rel="noopener noreferrer" className="text-green-400 hover:text-green-300">
                                                                <WhatsAppIcon className="w-6 h-6" />
                                                            </a>
                                                        )}
                                                    </div>
                                                </div>

                                                {isAuthenticated && (
                                                    <div className="pt-4 border-t border-indigo-800/50">
                                                        <h4 className="text-md font-semibold mb-3 text-indigo-200">إضافة نقاط يدوياً:</h4>
                                                        <PointActions student={student} addPoints={addPoints} />
                                                    </div>
                                                )}

                                                <div className="mt-4 pt-4 border-t border-indigo-800/50">
                                                    <div onClick={() => toggleHistoryDetails(student.id)} className="flex justify-between items-center cursor-pointer">
                                                        <h4 className="text-md font-semibold text-indigo-200">تفاصيل النقاط:</h4>
                                                        <ChevronDownIcon className={`w-5 h-5 text-gray-400 transition-transform ${visibleHistoryStudentId === student.id ? 'rotate-180' : ''}`} />
                                                    </div>
                                                    {visibleHistoryStudentId === student.id && (
                                                        <ul className="space-y-2 max-h-48 overflow-y-auto pr-2 mt-3">
                                                            {student.attendanceHistory && student.attendanceHistory.length > 0 ? student.attendanceHistory.map((record, index) => {
                                                                 const canDelete = loggedInAdmin?.isSuperAdmin;
                                                                 return (
                                                                    <li key={record.id || index} className="bg-indigo-800/50 p-2 rounded-md text-sm">
                                                                        <div className="flex justify-between items-center">
                                                                            <div className="flex-grow">
                                                                                <div className="flex justify-between items-center">
                                                                                    <span>{new Date(record.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })} - {record.typeName}</span>
                                                                                    <span className={`font-bold ${record.points > 0 ? 'text-green-400' : 'text-red-400'}`}>{record.points > 0 ? `+${record.points}`: record.points}</span>
                                                                                </div>
                                                                                {record.description && (
                                                                                    <p className="text-indigo-300 text-xs mt-1 pr-4">{record.description}</p>
                                                                                )}
                                                                                {isAuthenticated && record.recordedBy && (
                                                                                    <p className="text-indigo-400 text-xs mt-1 pr-4">بواسطة: {record.recordedBy}</p>
                                                                                )}
                                                                            </div>
                                                                            {canDelete && (
                                                                                <button 
                                                                                    onClick={() => handleDeletePointEntry(student.id, record)}
                                                                                    className="text-red-500 hover:text-red-400 p-1 ml-2 flex-shrink-0"
                                                                                    aria-label="حذف النقطة"
                                                                                >
                                                                                    <TrashIcon className="w-4 h-4"/>
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </li>
                                                                 );
                                                            }) : <p className="text-gray-500 text-sm text-center mt-2">لا يوجد سجل حضور بعد.</p>}
                                                        </ul>
                                                    )}
                                                </div>
                                                 
                                                {isAuthenticated && (
                                                    <div className="mt-4 pt-4 border-t border-indigo-800/50">
                                                        <button 
                                                            onClick={() => handleDeleteStudent(student.id)}
                                                            className="w-full flex items-center justify-center gap-2 bg-red-600/80 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-colors"
                                                        >
                                                            <TrashIcon className="w-5 h-5" />
                                                            <span>حذف المخدوم</span>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {activeView === 'leaderboard' && (
                         <div className="space-y-4">
                            {leaderboardStudents.map((student, index) => {
                                const rank = index + 1;

                                if (rank === 1) {
                                    return (
                                        <div key={student.id} className="p-5 flex justify-between items-center rounded-2xl border-2 border-amber-400 bg-gradient-to-br from-amber-400/30 via-amber-500/10 to-indigo-900/70 shadow-2xl shadow-amber-400/20 transform scale-105">
                                            <div className="flex items-center gap-4">
                                                <span className="text-4xl">🥇</span>
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                       <CrownIcon className="w-6 h-6 text-amber-300" />
                                                       <span className="text-xl font-bold text-white">{student.name}</span>
                                                    </div>
                                                    <span className="text-sm text-amber-200">المركز الأول</span>
                                                </div>
                                            </div>
                                            <div className="text-amber-300 font-black text-3xl">
                                                {student.points || 0}
                                            </div>
                                        </div>
                                    );
                                }

                                if (rank === 2) {
                                     return (
                                         <div key={student.id} className="p-4 flex justify-between items-center rounded-xl border-2 border-slate-300 bg-gradient-to-br from-slate-300/30 via-slate-400/10 to-indigo-900/70 shadow-xl shadow-slate-400/20">
                                            <div className="flex items-center gap-4">
                                                <span className="text-3xl">🥈</span>
                                                <div>
                                                    <span className="text-lg font-semibold text-slate-100">{student.name}</span>
                                                    <span className="block text-xs text-slate-300">المركز الثاني</span>
                                                </div>
                                            </div>
                                            <div className="text-slate-200 font-bold text-2xl">
                                                {student.points || 0}
                                            </div>
                                        </div>
                                    );
                                }

                                if (rank === 3) {
                                     return (
                                         <div key={student.id} className="p-4 flex justify-between items-center rounded-xl border-2 border-orange-500 bg-gradient-to-br from-orange-500/30 via-orange-600/10 to-indigo-900/70 shadow-lg shadow-orange-600/20">
                                            <div className="flex items-center gap-4">
                                                <span className="text-3xl">🥉</span>
                                                <div>
                                                   <span className="text-lg font-semibold text-orange-100">{student.name}</span>
                                                   <span className="block text-xs text-orange-200">المركز الثالث</span>
                                                </div>
                                            </div>
                                            <div className="text-orange-200 font-bold text-2xl">
                                                {student.points || 0}
                                            </div>
                                        </div>
                                    );
                                }
                                
                                // Ranks 4 and below
                                return (
                                    <div key={student.id} className="p-3 pl-4 flex justify-between items-center rounded-lg bg-indigo-900/70 border border-indigo-800/50">
                                        <div className="flex items-center gap-4">
                                            <span className="text-lg font-mono text-indigo-300 w-8 text-center">{rank}</span>
                                            <span className="font-medium">{student.name}</span>
                                        </div>
                                        <div className="text-amber-400 font-semibold text-lg">
                                            {student.points || 0}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                </main>
            </div>

            {isAuthenticated && (
                <div className="fixed bottom-6 left-6 flex flex-col items-center gap-4 z-40">
                     <button
                        onClick={() => setScannerOpen(true)}
                        className="bg-amber-500 hover:bg-amber-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out transform hover:scale-110"
                        aria-label="فتح الكاميرا للمسح"
                    >
                        <CameraIcon className="w-8 h-8" />
                    </button>
                    <button
                        onClick={() => setAddStudentModalOpen(true)}
                        className="bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out transform hover:scale-110"
                        aria-label="إضافة مخدوم جديد"
                    >
                        <UserPlusIcon className="w-8 h-8" />
                    </button>
                    {loggedInAdmin?.isSuperAdmin && (
                        <button
                            onClick={() => setAdminManagementModalOpen(true)}
                            className="bg-sky-600 hover:bg-sky-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out transform hover:scale-110"
                            aria-label="إدارة الخدام"
                        >
                            <ShieldCheckIcon className="w-8 h-8" />
                        </button>
                    )}
                </div>
            )}

            <Modal isOpen={isScannerOpen} onClose={() => setScannerOpen(false)} title="مسح كود المخدوم">
                <QRScanner onScanSuccess={handleScanSuccess} onScanFailure={(err) => { /* Silently handle failures */ }} />
            </Modal>
            
            <Modal isOpen={!!studentForAttendance} onClose={() => setStudentForAttendance(null)} title={`تسجيل نقاط لـ: ${studentForAttendance?.name}`}>
                {studentForAttendance && (
                     <PointActions
                        student={studentForAttendance}
                        addPoints={addPoints}
                        onActionAfterAdd={() => setStudentForAttendance(null)}
                        fromScan={true}
                    />
                )}
            </Modal>
            
            <Modal isOpen={!!studentForBarcode} onClose={() => setStudentForBarcode(null)} title={`باركود: ${studentForBarcode?.name}`}>
                {studentForBarcode && (
                    <div>
                        <BarcodeDisplay studentId={studentForBarcode.id} />
                        <p className="text-center text-indigo-300 mt-4 text-sm">
                            هذا هو الباركود الخاص بالطالب. يمكنه حفظه كصورة على موبايله لاستخدامه في تسجيل الحضور.
                        </p>
                    </div>
                )}
            </Modal>

            <Modal isOpen={!!scannedStudent} onClose={() => setScannedStudent(null)} title="تم تسجيل الحضور">
                {scannedStudent && (
                    <div className="text-center">
                        <h3 className="text-2xl font-bold text-green-400 mb-2">{scannedStudent.name}</h3>
                        <p className="text-lg">نقاطك الحالية: <span className="font-bold text-amber-400">{scannedStudent.points}</span></p>
                        <button onClick={() => setScannedStudent(null)} className="mt-6 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                            حسنًا
                        </button>
                    </div>
                )}
            </Modal>
            
            <Modal isOpen={isAuthModalOpen} onClose={() => setAuthModalOpen(false)} title="دخول الخدام">
                {!selectedAdmin ? (
                    <div>
                        <p className='text-indigo-300 mb-4'>الرجاء اختيار اسمك من القائمة:</p>
                        <div className="flex flex-col gap-3">
                            {superAdmin && (
                                <button
                                    key={superAdmin.id}
                                    onClick={() => setSelectedAdmin(superAdmin)}
                                    className="w-full bg-indigo-700 hover:bg-indigo-600 text-amber-400 font-bold py-3 px-4 rounded-lg transition-colors border-2 border-amber-500/50"
                                >
                                    {superAdmin.name}
                                </button>
                            )}
                            {otherAdmins.map(admin => (
                                <button
                                    key={admin.id}
                                    onClick={() => setSelectedAdmin(admin)}
                                    className="w-full bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition-colors"
                                >
                                    {admin.name}
                                </button>
                            ))}
                        </div>
                    </div>
                ) : (
                    <form onSubmit={handlePinSubmit}>
                        <p className='text-indigo-300 mb-4'>أهلاً, <span className="font-bold text-amber-400">{selectedAdmin.name}</span>. الرجاء إدخال الرقم السري.</p>
                        <input
                            type="password"
                            value={pinInput}
                            onChange={(e) => setPinInput(e.target.value)}
                            className="w-full bg-indigo-800 text-white border border-indigo-700 rounded-lg px-4 py-2 mb-4 text-center tracking-widest font-mono focus:outline-none focus:ring-2 focus:ring-amber-500"
                            placeholder="••••"
                            autoFocus
                        />
                        {authError && <p className="text-red-400 text-sm mb-4">{authError}</p>}
                        <div className="flex gap-4">
                            <button type="button" onClick={() => setSelectedAdmin(null)} className="w-full bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                رجوع
                            </button>
                            <button type="submit" className="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                دخول
                            </button>
                        </div>
                    </form>
                )}
            </Modal>

            <Modal isOpen={!!studentToDelete} onClose={() => setStudentToDelete(null)} title="تأكيد الحذف">
                {studentToDelete && (
                    <div className="text-center">
                        <p className="text-lg text-indigo-200 mb-6">
                            هل أنت متأكد أنك تريد حذف <span className="font-bold text-amber-400">{studentToDelete.name}</span>؟<br />
                            <span className="text-sm text-red-400">لا يمكن التراجع عن هذا الإجراء.</span>
                        </p>
                        <div className="flex justify-center gap-4">
                            <button 
                                onClick={() => setStudentToDelete(null)}
                                className="bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                            >
                                إلغاء
                            </button>
                            <button
                                onClick={confirmDeleteStudent}
                                className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                            >
                                نعم, احذف
                            </button>
                        </div>
                    </div>
                )}
            </Modal>
            
            <Modal isOpen={!!pointToDelete} onClose={() => setPointToDelete(null)} title="تأكيد حذف النقطة">
                {pointToDelete && (
                    <div className="text-center">
                        <p className="text-lg text-indigo-200 mb-4">
                            هل أنت متأكد من حذف هذه النقطة للمخدوم <span className="font-bold text-amber-400">{students.find(s => s.id === pointToDelete.studentId)?.name}</span>؟
                        </p>
                        <div className="bg-indigo-900/80 border border-indigo-700 p-3 rounded-lg mb-6 text-right space-y-1 text-sm">
                            <p><strong>النوع:</strong> {pointToDelete.record.typeName}</p>
                            <p><strong>النقاط:</strong> <span className={`font-bold ${pointToDelete.record.points > 0 ? 'text-green-400' : 'text-red-400'}`}>{pointToDelete.record.points > 0 ? `+${pointToDelete.record.points}`: pointToDelete.record.points}</span></p>
                            <p><strong>أضيفت بواسطة:</strong> {pointToDelete.record.recordedBy}</p>
                            {pointToDelete.record.description && <p><strong>السبب:</strong> {pointToDelete.record.description}</p>}
                        </div>
                        <div className="flex justify-center gap-4">
                            <button 
                                onClick={() => setPointToDelete(null)}
                                className="bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                            >
                                إلغاء
                            </button>
                            <button
                                onClick={confirmDeletePointEntry}
                                className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                            >
                                نعم, احذف
                            </button>
                        </div>
                    </div>
                )}
            </Modal>

            <Modal isOpen={isAddStudentModalOpen} onClose={() => setAddStudentModalOpen(false)} title="إضافة مخدوم جديد">
                 <div className="space-y-4">
                    <div>
                         <label htmlFor="new-student-name" className="block text-sm font-medium text-indigo-300 mb-2">اسم المخدوم</label>
                         <input
                             id="new-student-name"
                             type="text"
                             value={newStudentName}
                             onChange={(e) => setNewStudentName(e.target.value)}
                             placeholder="الاسم الثلاثي"
                             className="w-full bg-indigo-800 text-white placeholder-indigo-400 border border-indigo-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
                         />
                    </div>
                    <div>
                         <label htmlFor="new-student-phone" className="block text-sm font-medium text-indigo-300 mb-2">رقم الموبايل</label>
                         <input
                             id="new-student-phone"
                             type="tel"
                             value={newStudentPhone}
                             onChange={(e) => setNewStudentPhone(e.target.value)}
                             placeholder="012XXXXXXXX"
                             className="w-full bg-indigo-800 text-white placeholder-indigo-400 border border-indigo-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
                         />
                    </div>
                     <button
                         onClick={addStudent}
                         disabled={!newStudentName.trim() || !newStudentPhone.trim()}
                         className="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed !mt-6"
                     >
                         <UserPlusIcon className="w-5 h-5" />
                         <span>إضافة</span>
                     </button>
                 </div>
            </Modal>
            
            <Modal isOpen={isAdminManagementModalOpen} onClose={() => setAdminManagementModalOpen(false)} title="إدارة الخدام">
                <div className="bg-indigo-800/50 p-4 rounded-lg mb-6">
                    <h3 className="text-lg font-semibold mb-3 text-indigo-200">إضافة خادم جديد</h3>
                    <div className="flex flex-col md:flex-row items-stretch gap-3">
                        <input
                            type="text"
                            value={newAdminName}
                            onChange={(e) => setNewAdminName(e.target.value)}
                            placeholder="اسم الخادم..."
                            className="w-full md:w-auto flex-grow bg-indigo-800 text-white placeholder-indigo-300 border border-indigo-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
                        />
                        <input
                            type="password"
                            value={newAdminPin}
                            onChange={(e) => setNewAdminPin(e.target.value)}
                            placeholder="الرقم السري"
                            className="w-full md:w-48 bg-indigo-800 text-white placeholder-indigo-300 border border-indigo-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
                        />
                        <button
                            onClick={handleAddAdmin}
                            className="flex-shrink-0 flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                        >
                            <UserPlusIcon className="w-5 h-5" />
                            <span>إضافة</span>
                        </button>
                    </div>
                </div>

                <h3 className="text-lg font-semibold mt-6 mb-3 text-indigo-200">قائمة الخدام الحالية</h3>
                <div className="space-y-3">
                    {admins.filter(a => !a.isSuperAdmin).map(admin => (
                        <div key={admin.id} className="p-3 bg-indigo-800/50 rounded-lg space-y-3">
                           <div className="flex justify-between items-center">
                               <div>
                                   <p className="font-semibold">{admin.name}</p>
                                   {admin.isLocked ? (
                                       <span className="text-xs text-red-400 font-semibold">● معطل</span>
                                   ) : (
                                       <span className="text-xs text-green-400 font-semibold">● نشط</span>
                                   )}
                               </div>
                               {admin.failedAttempts >= 5 && (
                                   <button 
                                       onClick={() => handleUnlockAdminByFailure(admin.id)}
                                       className="flex items-center gap-1.5 bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold py-1 px-2 rounded-lg transition-colors"
                                   >
                                       <KeyIcon className="w-3 h-3"/>
                                       <span>مقفل (5 محاولات)</span>
                                   </button>
                               )}
                           </div>
                            
                            {editingAdminId === admin.id ? (
                                <div className="flex items-center gap-2">
                                    <input
                                        type="password"
                                        value={editingAdminPinValue}
                                        onChange={e => setEditingAdminPinValue(e.target.value)}
                                        placeholder="الرقم السري الجديد"
                                        className="flex-grow bg-indigo-700 text-white placeholder-indigo-300 border border-indigo-600 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-amber-500"
                                        autoFocus
                                    />
                                    <button onClick={() => handleSaveAdminPin(admin.id)} className="text-green-400 hover:text-green-300 p-1.5 rounded-full bg-indigo-900/50"><CheckIcon className="w-5 h-5"/></button>
                                    <button onClick={() => setEditingAdminId(null)} className="text-red-400 hover:text-red-300 p-1.5 rounded-full bg-indigo-900/50"><XIcon className="w-5 h-5"/></button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => handleToggleAdminStatus(admin.id)}
                                        className={`flex-1 text-sm font-bold py-1.5 px-3 rounded-lg transition-colors ${admin.isLocked ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white`}
                                    >
                                        {admin.isLocked ? 'تفعيل' : 'تعطيل'}
                                    </button>
                                    <button
                                        onClick={() => handleStartEditPin(admin)}
                                        className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1.5 px-3 rounded-lg transition-colors"
                                    >
                                        تغيير الرقم السري
                                    </button>
                                </div>
                            )}

                        </div>
                    ))}
                </div>
            </Modal>

            {toastMessage && (
                <div className="fixed bottom-6 right-6 bg-indigo-900 text-white py-2 px-5 rounded-lg shadow-xl border border-indigo-700 animate-fade-in-out">
                    <p>{toastMessage}</p>
                </div>
            )}
        </div>
    );
};


// --- Mount App ---
const rootElement = document.getElementById('root');
const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

    </script>
  </body>
</html>